<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coletor FCM</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-100">

    <div class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            üîî Coletor de Token FCM
        </h1>

        <div id="status" class="p-4 mb-4 text-sm bg-blue-100 text-blue-800 rounded-lg">
            Aguardando...
        </div>

        <div class="space-y-4">
            <label class="block text-sm font-medium text-gray-700">Token FCM:</label>
            <textarea id="token" readonly rows="5" 
                class="w-full p-3 border rounded-lg bg-gray-50 text-xs font-mono"
                placeholder="Token aparecer√° aqui..."></textarea>

            <button id="copy" disabled
                class="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50">
                Copiar Token
            </button>

            <div id="success" class="hidden p-3 bg-green-100 text-green-800 rounded-lg text-center">
                ‚úÖ Copiado!
            </div>

            <div id="debug" class="p-3 bg-gray-100 rounded-lg text-xs font-mono">
                <strong>Debug:</strong><br>
                <span id="debug-text">Carregando...</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js";

        const config = {
            apiKey: "AIzaSyA2_VAJZir5DpatOgfByp7oEzfM2VEbl-g",
            authDomain: "aqui-na-feira-4afd5.firebaseapp.com",
            projectId: "aqui-na-feira-4afd5",
            storageBucket: "aqui-na-feira-4afd5.firebasestorage.app",
            messagingSenderId: "997997717655",
            appId: "1:997997717655:web:476e8272da6d65ddf7a1d2"
        };
        
        const VAPID = "BBt7NXjEBXBxeZ2N_NdBOixxaLUtP2qgHwz65cIO-OFqI4UeZDnAU7jdxGAaamPloS2quvxorN7ZXZvbIMpmiK8";

        const status = document.getElementById('status');
        const token = document.getElementById('token');
        const copy = document.getElementById('copy');
        const success = document.getElementById('success');
        const debugText = document.getElementById('debug-text');

        function debug(msg) {
            console.log(msg);
            debugText.innerHTML += msg + '<br>';
        }

        async function init() {
            try {
                // MOSTRA TODAS AS URLS IMPORTANTES
                const baseUrl = window.location.origin;
                const currentPath = window.location.pathname;
                const swPath = `${currentPath}firebase-messaging-sw.js`;
                
                debug(`Base URL: ${baseUrl}`);
                debug(`Current Path: ${currentPath}`);
                debug(`SW Path: ${swPath}`);

                status.textContent = '1/6: Inicializando...';
                const app = initializeApp(config);
                
                status.textContent = '2/6: Verificando suporte...';
                if (!('serviceWorker' in navigator)) throw new Error('Sem suporte a SW');
                if (!('Notification' in window)) throw new Error('Sem suporte a notifica√ß√µes');

                // DESREGISTRA TODOS OS SWs ANTIGOS
                status.textContent = '3/6: Limpando Service Workers antigos...';
                const registrations = await navigator.serviceWorker.getRegistrations();
                debug(`${registrations.length} SWs encontrados`);
                for (const reg of registrations) {
                    await reg.unregister();
                    debug(`SW removido: ${reg.scope}`);
                }

                // REGISTRA O SW NO CAMINHO RELATIVO
                status.textContent = '4/6: Registrando novo SW...';
                debug(`Tentando registrar: ${swPath}`);
                
                const registration = await navigator.serviceWorker.register(swPath, {
                    scope: currentPath,
                    updateViaCache: 'none'
                });
                
                debug(`‚úÖ SW registrado! Scope: ${registration.scope}`);
                
                await navigator.serviceWorker.ready;
                debug('‚úÖ SW pronto!');

                status.textContent = '5/6: Solicitando permiss√£o...';
                const perm = await Notification.requestPermission();
                if (perm !== 'granted') throw new Error('Permiss√£o negada');
                debug('‚úÖ Permiss√£o concedida');

                status.textContent = '6/6: Gerando token...';
                const messaging = getMessaging(app);
                const t = await getToken(messaging, { 
                    vapidKey: VAPID,
                    serviceWorkerRegistration: registration
                });

                if (t) {
                    token.value = t;
                    copy.disabled = false;
                    copy.onclick = () => {
                        navigator.clipboard.writeText(t).catch(() => {
                            const tmp = document.createElement('textarea');
                            tmp.value = t;
                            document.body.appendChild(tmp);
                            tmp.select();
                            document.execCommand('copy');
                            document.body.removeChild(tmp);
                        });
                        success.classList.remove('hidden');
                        setTimeout(() => success.classList.add('hidden'), 2000);
                    };
                    status.textContent = '‚úÖ TOKEN GERADO!';
                    status.className = 'p-4 mb-4 text-sm bg-green-100 text-green-800 rounded-lg';
                    debug('‚úÖ Token obtido com sucesso!');
                } else {
                    throw new Error('Token vazio');
                }
            } catch (e) {
                status.textContent = `‚ùå ERRO: ${e.message}`;
                status.className = 'p-4 mb-4 text-sm bg-red-100 text-red-800 rounded-lg';
                debug(`‚ùå ERRO: ${e.message}`);
                debug(`Stack: ${e.stack}`);
                console.error('Erro completo:', e);
            }
        }

        window.onload = init;
    </script>
</body>
</html>