<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coletor FCM</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-100">

    <div class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            üîî Coletor de Token FCM
        </h1>

        <div id="status" class="p-4 mb-4 text-sm bg-blue-100 text-blue-800 rounded-lg">
            Aguardando...
        </div>

        <div class="space-y-4">
            <label class="block text-sm font-medium text-gray-700">Token FCM:</label>
            <textarea id="token" readonly rows="5" 
                class="w-full p-3 border rounded-lg bg-gray-50 text-xs font-mono"
                placeholder="Token aparecer√° aqui..."></textarea>

            <button id="copy" disabled
                class="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50">
                Copiar Token
            </button>

            <div id="success" class="hidden p-3 bg-green-100 text-green-800 rounded-lg text-center">
                ‚úÖ Copiado!
            </div>

            <div id="debug" class="p-3 bg-gray-100 rounded-lg text-xs font-mono overflow-auto max-h-40">
                <strong>Debug:</strong><br>
                <span id="debug-text"></span>
            </div>
        </div>
    </div>

    <!-- IMPORTANTE: Usar vers√£o 9.22.1 COMPAT para ter mais controle -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>

    <script>
        const config = {
            apiKey: "AIzaSyA2_VAJZir5DpatOgfByp7oEzfM2VEbl-g",
            authDomain: "aqui-na-feira-4afd5.firebaseapp.com",
            projectId: "aqui-na-feira-4afd5",
            storageBucket: "aqui-na-feira-4afd5.firebasestorage.app",
            messagingSenderId: "997997717655",
            appId: "1:997997717655:web:476e8272da6d65ddf7a1d2"
        };
        
        const VAPID = "BBt7NXjEBXBxeZ2N_NdBOixxaLUtP2qgHwz65cIO-OFqI4UeZDnAU7jdxGAaamPloS2quvxorN7ZXZvbIMpmiK8";

        const status = document.getElementById('status');
        const token = document.getElementById('token');
        const copy = document.getElementById('copy');
        const success = document.getElementById('success');
        const debugText = document.getElementById('debug-text');

        function debug(msg) {
            console.log(msg);
            debugText.innerHTML += msg + '<br>';
        }

        async function init() {
            try {
                const currentPath = window.location.pathname;
                const swFullPath = `${currentPath}firebase-messaging-sw.js`;
                
                debug(`üåê URL atual: ${window.location.href}`);
                debug(`üìÇ Caminho SW: ${swFullPath}`);

                status.textContent = '1/5: Verificando suporte...';
                if (!('serviceWorker' in navigator)) throw new Error('Sem suporte a SW');
                if (!('Notification' in window)) throw new Error('Sem suporte a notifica√ß√µes');
                debug('‚úÖ Suporte OK');

                // CR√çTICO: Registrar o SW MANUALMENTE antes do Firebase
                status.textContent = '2/5: Registrando Service Worker...';
                debug(`üîß Registrando SW em: ${swFullPath}`);
                
                // Remove SWs antigos
                const oldRegs = await navigator.serviceWorker.getRegistrations();
                for (const reg of oldRegs) {
                    await reg.unregister();
                    debug(`üóëÔ∏è SW removido: ${reg.scope}`);
                }

                const registration = await navigator.serviceWorker.register(swFullPath, {
                    scope: currentPath,
                    updateViaCache: 'none'
                });
                
                debug(`‚úÖ SW registrado! Scope: ${registration.scope}`);
                await navigator.serviceWorker.ready;
                debug('‚úÖ SW ativo e pronto!');

                status.textContent = '3/5: Inicializando Firebase...';
                firebase.initializeApp(config);
                debug('‚úÖ Firebase inicializado');

                status.textContent = '4/5: Solicitando permiss√£o...';
                const perm = await Notification.requestPermission();
                if (perm !== 'granted') throw new Error('Permiss√£o negada');
                debug('‚úÖ Permiss√£o concedida');

                status.textContent = '5/5: Gerando token...';
                
                // Usa a API compat que respeita o SW j√° registrado
                const messaging = firebase.messaging();
                
                // Passa o registration explicitamente
                messaging.useServiceWorker(registration);
                
                const t = await messaging.getToken({ vapidKey: VAPID });

                if (t) {
                    token.value = t;
                    copy.disabled = false;
                    copy.onclick = () => {
                        navigator.clipboard.writeText(t).catch(() => {
                            const tmp = document.createElement('textarea');
                            tmp.value = t;
                            document.body.appendChild(tmp);
                            tmp.select();
                            document.execCommand('copy');
                            document.body.removeChild(tmp);
                        });
                        success.classList.remove('hidden');
                        setTimeout(() => success.classList.add('hidden'), 2000);
                    };
                    status.textContent = '‚úÖ TOKEN GERADO COM SUCESSO!';
                    status.className = 'p-4 mb-4 text-sm bg-green-100 text-green-800 rounded-lg';
                    debug('‚úÖ Token obtido!');
                    debug(`Token: ${t.substring(0, 50)}...`);
                } else {
                    throw new Error('Token vazio retornado');
                }
            } catch (e) {
                status.textContent = `‚ùå ERRO: ${e.message}`;
                status.className = 'p-4 mb-4 text-sm bg-red-100 text-red-800 rounded-lg';
                debug(`‚ùå ERRO: ${e.message}`);
                if (e.stack) debug(`Stack: ${e.stack.substring(0, 200)}`);
                console.error('Erro completo:', e);
            }
        }

        window.onload = init;
    </script>
</body>
</html>