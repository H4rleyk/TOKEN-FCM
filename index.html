<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coletor de Token FCM (Teste)</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 text-center">
            <svg class="w-8 h-8 inline-block text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                </path>
            </svg>
            Coletor FCM
        </h1>
        <p class="text-gray-500 text-center mb-6">
            Obtenha e copie o token para teste de push notifications.
        </p>

        <div id="status-message" class="p-3 mb-4 text-sm font-medium text-blue-700 bg-blue-100 rounded-lg hidden"
            role="alert">
            Status: Iniciando Firebase...
        </div>

        <div class="space-y-4">
            <label for="fcm-token" class="block text-sm font-medium text-gray-700">Token FCM Gerado (Copie este valor):</label>
            <textarea id="fcm-token" readonly rows="4" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 break-all placeholder-gray-400 focus:ring-red-500 focus:border-red-500" placeholder="Aguardando token..." aria-label="Token FCM"></textarea>

            <button id="copy-button" class="w-full flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-3 9
                </svg>
                Copiar Token
            </button>
            <div id="copy-success"
                class="mt-2 p-3 text-sm font-medium text-green-700 bg-green-100 rounded-lg hidden text-center"
                role="alert">
                Token copiado com sucesso!
            </div>
        </div>
    </div>

    <!-- Script de Inicialização do Firebase e Lógica FCM -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

    const firebaseConfig = {
          apiKey: "AIzaSyA2_VAJZir5DpatOgfByp7oEzfM2VEbl-g",
          authDomain: "aqui-na-feira-4afd5.firebaseapp.com",
          projectId: "aqui-na-feira-4afd5",
          storageBucket: "aqui-na-feira-4afd5.firebasestorage.app",
          messagingSenderId: "997997717655",
          appId: "1:997997717655:web:476e8272da6d65ddf7a1d2",
         measurementId: "G-ZFJBGCEZVD"
    };
        // -----------------------------------------------

        // --- ATENÇÃO CRÍTICA: SUBSTITUA O VAPID KEY ABAIXO ---
        const VAPID_KEY = "BBt7NXjEBXBxeZ2N_NdBOixxaLUtP2qgHwz65cIO-OFqI4UeZDnAU7jdxGAaamPloS2quvxorN7ZXZvbIMpmiK8"; // Ex: BOu4L_s-tL6q...
        // -----------------------------------------------------

        const tokenElement = document.getElementById('fcm-token');
        const statusElement = document.getElementById('status-message');
        const copyButton = document.getElementById('copy-button');
        const copySuccess = document.getElementById('copy-success');

        function updateStatus(message, type = 'info') {
            statusElement.textContent = `Status: ${message}`;
            statusElement.className = `p-3 mb-4 text-sm font-medium rounded-lg ${type === 'error' ? 'text-red-700 bg-red-100' : 'text-blue-700 bg-blue-100'}`;
            statusElement.style.display = 'block';
        }

        function copyToClipboard(text) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                copySuccess.style.display = 'block';
                setTimeout(() => copySuccess.style.display = 'none', 3000);
            } catch (err) {
                console.error('Falha ao copiar:', err);
                updateStatus('Erro ao copiar. Tente selecionar o texto manualmente.', 'error');
            } finally {
                document.body.removeChild(tempInput);
            }
        }

        async function setupFCM() {
            if (VAPID_KEY === "COLE_A_SUA_CHAVE_VAPID_AQUI") {
                 updateStatus('ERRO: Por favor, substitua a VAPID Key no código.', 'error');
                 tokenElement.placeholder = "Chave VAPID faltando ou incorreta.";
                 return;
            }

            try {
                updateStatus("1/3: Inicializando App...");
                const app = initializeApp(firebaseConfig);
                
                if (!('serviceWorker' in navigator)) {
                    updateStatus("ERRO: Service Workers não suportados neste ambiente/navegador.", 'error');
                    return;
                }

                updateStatus("2/3: Obtendo serviço de Mensagens...");
                const messaging = getMessaging(app);

                updateStatus("3/3: Solicitando permissão e obtendo token...");
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    updateStatus("Permissão concedida. Buscando token...");
                    
                    const currentToken = await getToken(messaging, { 
                        vapidKey: VAPID_KEY,
                    });

                    if (currentToken) {
                        tokenElement.value = currentToken;
                        copyButton.disabled = false;
                        copyButton.onclick = () => copyToClipboard(currentToken);
                        updateStatus("Token FCM gerado com sucesso! Pronto para copiar.", 'info');
                    } else {
                        updateStatus("Erro: Não foi possível obter o token. Verifique as configurações.", 'error');
                        tokenElement.placeholder = "Não foi possível obter o token.";
                    }
                } else {
                    updateStatus("Permissão de notificação negada. O token não pode ser gerado.", 'error');
                    tokenElement.placeholder = "Permissão negada.";
                }

            } catch (error) {
                console.error("Erro geral no FCM:", error);
                updateStatus(`Erro fatal: ${error.message || 'Falha na inicialização do FCM.'}`, 'error');
                tokenElement.placeholder = "Erro ao carregar FCM.";
            }
        }

        window.onload = setupFCM;

    </script>
</body>

</html>